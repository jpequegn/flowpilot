# Daily Code Review

Automatically review pull requests using Claude CLI and post feedback to GitHub.

## Overview

This workflow:
1. Fetches open pull requests from GitHub
2. Gets the diff for each PR
3. Sends the diff to Claude for code review
4. Posts the review as a PR comment

## Workflow

```yaml
name: daily-code-review
description: Automated code review for open PRs using Claude

triggers:
  - type: cron
    schedule: "0 9 * * 1-5"  # 9 AM weekdays
  - type: manual

nodes:
  - id: fetch-prs
    type: http
    config:
      url: "https://api.github.com/repos/{{ env('GITHUB_REPO') }}/pulls"
      method: GET
      headers:
        Authorization: "Bearer {{ env('GITHUB_TOKEN') }}"
        Accept: application/vnd.github.v3+json

  - id: log-pr-count
    type: log
    config:
      message: "Found {{ nodes.fetch-prs.output.body | length }} open PRs"
      level: info
    depends_on:
      - fetch-prs

  - id: process-prs
    type: loop
    config:
      items: "{{ nodes.fetch-prs.output.body }}"
      item_var: pr
      max_parallel: 2
      body:
        - id: get-diff
          type: http
          config:
            url: "{{ pr.diff_url }}"
            method: GET
            headers:
              Authorization: "Bearer {{ env('GITHUB_TOKEN') }}"

        - id: review-code
          type: claude_cli
          config:
            system: |
              You are an expert code reviewer. Review the following diff and provide:
              1. A summary of changes
              2. Potential issues or bugs
              3. Suggestions for improvement
              4. Security concerns if any

              Be constructive and specific. Format as markdown.
            prompt: |
              Review this pull request:

              Title: {{ pr.title }}
              Author: {{ pr.user.login }}

              Changes:
              ```diff
              {{ nodes.get-diff.output.body }}
              ```
          depends_on:
            - get-diff

        - id: post-comment
          type: http
          config:
            url: "{{ pr.comments_url }}"
            method: POST
            headers:
              Authorization: "Bearer {{ env('GITHUB_TOKEN') }}"
              Accept: application/vnd.github.v3+json
            body:
              body: |
                ## ðŸ¤– Automated Code Review

                {{ nodes.review-code.output.response }}

                ---
                *This review was generated by FlowPilot using Claude.*
          depends_on:
            - review-code

        - id: log-reviewed
          type: log
          config:
            message: "Reviewed PR #{{ pr.number }}: {{ pr.title }}"
            level: info
          depends_on:
            - post-comment
    depends_on:
      - fetch-prs

  - id: summary
    type: log
    config:
      message: "Code review complete. Reviewed {{ nodes.process-prs.output.completed }} PRs."
      level: info
    depends_on:
      - process-prs
```

## Setup

### Environment Variables

```bash
export GITHUB_TOKEN="ghp_xxxxxxxxxxxx"
export GITHUB_REPO="owner/repo"
```

### GitHub Token Permissions

The token needs:
- `repo` - Full repository access
- Or for public repos: `public_repo`

## Customization

### Review Specific Labels

Add a condition to only review PRs with certain labels:

```yaml
- id: process-prs
  type: loop
  config:
    items: "{{ nodes.fetch-prs.output.body | selectattr('labels', 'defined') | list }}"
    # ... rest of configuration
```

### Skip Draft PRs

```yaml
- id: process-prs
  type: loop
  config:
    items: "{{ nodes.fetch-prs.output.body | rejectattr('draft', 'true') | list }}"
```

### Custom Review Focus

Modify the Claude system prompt to focus on specific areas:

```yaml
- id: review-code
  type: claude_cli
  config:
    system: |
      You are a security-focused code reviewer. Focus on:
      1. Input validation and sanitization
      2. Authentication and authorization issues
      3. SQL injection and XSS vulnerabilities
      4. Sensitive data exposure
```

## Tips

- Run with `--verbose` to see Claude's responses
- Use `max_parallel: 1` for rate limiting
- Store the GitHub token securely
- Consider adding retry logic for API calls

## Related Examples

- [GitHub Webhook Handler](github-webhook-handler.md) - Process GitHub events in real-time
